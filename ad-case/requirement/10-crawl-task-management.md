# 爬取任务管理功能需求文档

## 1. 功能概述

### 1.1 背景

当前爬取功能通过命令行脚本执行，存在以下问题：

- **使用体验差**：需要手动执行脚本，配置参数复杂
- **进度感知弱**：无法实时查看爬取进度和状态
- **任务管理不便**：无法方便地创建、暂停、恢复爬取任务
- **缺乏可视化**：无法直观地查看任务历史和执行情况

### 1.2 目标

提供可视化的爬取任务管理功能，让用户能够：

1. **便捷创建任务**：通过前端界面创建爬取任务，设置爬取范围和参数
2. **实时进度监控**：实时查看爬取进度、成功数、失败数等统计信息
3. **任务控制**：支持暂停、恢复、终止爬取任务
4. **任务历史**：查看历史任务记录和执行结果
5. **任务配置**：灵活配置爬取参数（页码范围、案例类型、搜索关键词等）

### 1.3 用户价值

- **提升效率**：无需手动执行脚本，通过界面即可管理爬取任务
- **增强可控性**：实时了解爬取进度，可随时控制任务执行
- **降低门槛**：非技术人员也能轻松使用爬取功能
- **提高可靠性**：任务状态可视化，便于发现和处理问题

## 2. 功能需求

### 2.1 任务创建

#### 2.1.1 创建任务表单

用户可以通过前端界面创建爬取任务，需要配置以下参数：

**基础配置**：

- **任务名称**（必填）：自定义任务名称，便于识别和管理
- **数据源**（必填）：选择爬取的数据源（当前仅支持"广告门"）
- **任务描述**（可选）：任务说明和备注信息

**爬取范围配置**：

- **起始页码**（必填，默认：0）：从第几页开始爬取
- **结束页码**（必填，默认：100）：爬取到第几页（或设置为"全部"）
- **每页数量**（只读，默认：20）：API 返回的每页案例数量（由数据源决定）

**筛选条件**（可选）：

- **案例类型**（可选）：
  - 全部（默认）
  - 精选案例
  - 其他类型（根据数据源支持的类型）
- **搜索关键词**（可选）：只爬取包含特定关键词的案例
- **品牌筛选**（可选）：只爬取特定品牌的案例（如果数据源支持）
- **行业筛选**（可选）：只爬取特定行业的案例（如果数据源支持）

**高级配置**（可选，默认使用系统配置）：

- **批次大小**（默认：100）：每批保存到 JSON 的案例数量
- **请求延迟**（默认：2-5 秒）：每次请求之间的延迟时间范围
- **最大重试次数**（默认：3）：单个案例爬取失败时的重试次数
- **启用断点续传**（默认：是）：任务中断后是否支持续传

**执行策略**：

- **立即执行**：创建后立即开始执行
- **定时执行**：设置执行时间，到时间后自动开始
- **仅保存**：仅保存任务配置，不立即执行

#### 2.1.2 任务创建流程

```
1. 用户填写任务配置表单
   ↓
2. 前端验证表单数据
   ↓
3. 提交任务创建请求到后端
   ↓
4. 后端验证参数并创建任务记录
   ↓
5. 如果选择"立即执行"，后端启动爬取任务
   ↓
6. 返回任务ID和状态给前端
   ↓
7. 前端跳转到任务详情页或任务列表页
```

### 2.2 任务列表

#### 2.2.1 列表展示

任务列表页展示所有爬取任务，包括以下信息：

**任务基本信息**：

- **任务名称**：可点击跳转到任务详情
- **任务 ID**：唯一标识符
- **创建时间**：任务创建时间
- **创建人**：任务创建者（如果支持多用户）

**任务状态**：

- **状态标签**：使用不同颜色标识任务状态
  - 🟢 **等待中**（Pending）：任务已创建，等待执行
  - 🔵 **运行中**（Running）：任务正在执行
  - 🟡 **已暂停**（Paused）：任务被暂停，可恢复
  - 🟢 **已完成**（Completed）：任务执行完成
  - 🔴 **已失败**（Failed）：任务执行失败
  - ⚫ **已取消**（Cancelled）：任务被取消
  - ⏸️ **已终止**（Terminated）：任务被手动终止

**执行信息**：

- **开始时间**：任务开始执行的时间
- **结束时间**：任务结束的时间（如果已结束）
- **执行时长**：任务执行的总时长（运行中任务显示已执行时长）

**进度信息**：

- **总页数**：需要爬取的总页数
- **已完成页数**：已爬取的页数
- **进度百分比**：已完成页数 / 总页数
- **进度条**：可视化进度条展示

**统计信息**：

- **已爬取数**：已爬取的案例总数
- **已保存数**：已保存到 JSON 的案例数
- **失败数**：爬取失败的案例数
- **成功率**：成功数 / 总爬取数

#### 2.2.2 列表筛选和排序

**筛选功能**：

- **按状态筛选**：筛选特定状态的任务
- **按数据源筛选**：筛选特定数据源的任务
- **按时间范围筛选**：筛选创建时间在指定范围内的任务
- **按关键词搜索**：搜索任务名称或描述

**排序功能**：

- **按创建时间排序**：最新创建的在前面（默认）
- **按开始时间排序**：最新开始的在前面
- **按状态排序**：运行中的任务优先显示
- **按进度排序**：按完成进度排序

#### 2.2.3 批量操作

- **批量删除**：删除选中的任务（仅限已完成、已失败、已取消的任务）
- **批量导出**：导出选中任务的统计信息

### 2.3 任务详情

#### 2.3.1 基本信息展示

任务详情页展示任务的完整信息：

**任务配置信息**：

- 显示创建任务时配置的所有参数
- 支持查看和编辑（仅限等待中或已暂停的任务）

**任务状态信息**：

- 当前状态、开始时间、结束时间、执行时长
- 状态变更历史（状态变更时间线）

**进度信息**：

- **总体进度**：
  - 进度条：可视化展示整体进度
  - 已完成页数 / 总页数
  - 预计剩余时间（基于当前速度估算）
- **当前页信息**：
  - 当前正在爬取的页码
  - 当前页已爬取案例数
  - 当前页状态（爬取中、已完成、失败）

**统计信息**：

- **爬取统计**：
  - 总爬取数
  - 成功数
  - 失败数
  - 跳过数（已存在的案例）
  - 成功率
- **保存统计**：
  - 已保存批次数
  - 已保存案例数
  - 最后保存时间
- **性能统计**：
  - 平均爬取速度（案例/分钟）
  - 平均请求延迟
  - 错误率

#### 2.3.2 实时日志

**日志展示**：

- **日志列表**：实时显示任务执行日志
- **日志级别**：支持按级别筛选（INFO、WARNING、ERROR）
- **日志搜索**：支持关键词搜索日志内容
- **自动滚动**：新日志自动滚动到底部
- **日志导出**：支持导出日志到文件

**日志内容**：

- 任务开始/结束信息
- 每页爬取开始/完成信息
- 案例爬取成功/失败信息
- 错误信息和异常堆栈
- 批次保存信息
- 状态变更信息

#### 2.3.3 任务控制

**控制按钮**（根据任务状态显示）：

- **开始执行**：开始执行等待中的任务
- **暂停**：暂停运行中的任务（保存当前进度）
- **恢复**：恢复已暂停的任务（从暂停位置继续）
- **终止**：终止运行中的任务（不保存进度）
- **重试**：重新执行已失败的任务
- **删除**：删除任务（仅限已完成、已失败、已取消的任务）

**操作确认**：

- 暂停、终止、删除等关键操作需要用户确认
- 显示操作影响说明（如"终止后将无法恢复进度"）

### 2.4 实时进度更新

#### 2.4.1 WebSocket 实时推送

**推送内容**：

- 任务状态变更
- 进度更新（已完成页数、已爬取数等）
- 统计信息更新
- 实时日志
- 错误信息

**推送频率**：

- 状态变更：立即推送
- 进度更新：每爬取完一页推送一次
- 统计信息：每 5 秒推送一次（或每爬取 10 个案例推送一次）
- 日志：实时推送

#### 2.4.2 轮询机制（备选方案）

如果 WebSocket 不可用，使用轮询机制：

- 运行中的任务：每 3-5 秒轮询一次
- 已完成的任务：不轮询
- 已失败的任务：不轮询

### 2.5 任务历史

#### 2.5.1 历史记录

- 显示所有历史任务（包括已完成、已失败、已取消的任务）
- 支持按时间范围、状态、数据源筛选
- 支持查看历史任务的详细信息

#### 2.5.2 任务统计

**总体统计**：

- 总任务数
- 各状态任务数量分布
- 总爬取案例数
- 平均任务执行时长
- 任务成功率

**时间趋势**：

- 每日任务数量趋势图
- 每日爬取案例数量趋势图
- 任务成功率趋势图

## 3. 用户体验需求

### 3.1 界面展示需求

**任务列表页**：

- 清晰的卡片式布局，便于快速浏览
- 状态用颜色区分，一目了然
- 进度条直观展示进度
- 关键信息突出显示（任务名称、状态、进度、统计信息）

**任务详情页**：

- 左侧：任务基本信息和控制按钮
- 中间：进度信息和统计信息
- 右侧：实时日志（可折叠）

**创建任务页**：

- 分步骤表单（基础配置 → 爬取范围 → 筛选条件 → 高级配置）
- 实时表单验证
- 参数说明和提示

### 3.2 交互体验需求

**实时反馈**：

- 操作后立即显示反馈
- 状态变更有动画效果
- 错误信息清晰提示

**操作确认**：

- 关键操作（暂停、终止、删除）需要确认
- 显示操作影响说明（如"终止后将无法恢复进度"）

**加载状态**：

- 数据加载时显示加载动画
- 长时间操作显示进度提示

**实时更新**：

- 运行中的任务需要实时更新进度和统计信息
- 支持实时查看任务执行日志
- 任务状态变更时及时通知用户

## 4. 非功能需求

### 5.1 性能要求

- 任务列表加载时间 < 1 秒
- 任务详情加载时间 < 2 秒
- 实时进度更新延迟 < 3 秒
- 支持同时运行多个爬取任务（建议最多 3-5 个）

### 5.2 可靠性要求

- 任务状态持久化，服务重启后状态不丢失
- 支持任务断点续传
- 任务失败后可以重试
- 日志完整记录，便于问题排查

### 5.3 安全性要求

- 任务创建需要权限验证（如果支持多用户）
- 防止恶意创建大量任务
- 任务参数验证，防止注入攻击
- 日志不包含敏感信息

## 5. 后续扩展需求

### 5.1 定时任务

- 支持设置定时执行任务（每天、每周等）
- 支持任务模板，快速创建相似任务

### 5.2 任务调度

- 智能任务调度，避免资源冲突
- 任务优先级管理
- 任务依赖关系（任务 A 完成后执行任务 B）

### 5.3 多数据源支持

- 支持创建不同数据源的爬取任务
- 数据源特定的配置选项

### 5.4 任务通知

- 任务完成时发送通知（邮件、站内消息等）
- 任务失败时发送告警

---

## 6. 相关文档

**技术设计文档**：`technical-solution/docs/design/crawl-task-management-design.md`

该文档包含详细的技术实现方案，包括：

- API 接口设计
- 数据库设计
- 后端任务执行器设计
- 前端组件设计
- 实施计划

---

**文档版本**：v1.0  
**创建时间**：2024-01-XX  
**最后更新**：2024-01-XX
