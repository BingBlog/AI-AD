# 广告案例库项目 - Cursor Rules

## 项目概述

这是一个广告案例检索系统，包含：
- **后端**: FastAPI + PostgreSQL + 向量检索
- **前端**: React + TypeScript + Ant Design
- **向量模型**: BAAI/bge-large-zh-v1.5 (本地模型)

## ⚠️ 关键配置信息（必须遵守）

### 数据库配置

**数据库名称**: `ad_case_db` (固定，不要修改)

**连接配置位置**: `backend/.env`

```env
DB_HOST=localhost
DB_PORT=5432
DB_NAME=ad_case_db          # ⚠️ 固定值，不要修改
DB_USER=bing               # 根据实际情况修改
DB_PASSWORD=               # 根据实际情况修改
```

**重要规则**:
- ⚠️ **永远不要修改数据库名称** `ad_case_db`，避免数据丢失
- ⚠️ 开发环境不要连接到生产数据库
- ⚠️ 修改数据库配置前，必须确认数据库名称正确

### Python 虚拟环境

**虚拟环境位置**（按优先级）:
1. `backend/venv`
2. `backend/.venv`
3. `technical-solution/venv`
4. `technical-solution/.venv`

**重要规则**:
- ⚠️ **启动后端前必须激活虚拟环境**
- ⚠️ 不要在系统 Python 环境中安装依赖
- ⚠️ 使用 `which python` 确认 Python 路径来自虚拟环境
- ⚠️ 如果虚拟环境不存在，必须先创建：`python3 -m venv venv`

### 向量模型配置

**模型信息**:
- 模型名称: `BAAI/bge-large-zh-v1.5`
- 向量维度: 1024
- **必须使用本地模型路径**

**配置位置**: `backend/.env`

```env
# ⚠️ 必须配置本地模型路径
VECTOR_MODEL_PATH=/path/to/bge-large-zh-v1.5  # 本地模型目录路径
VECTOR_DIMENSION=1024
VECTOR_OFFLINE_MODE=true  # ⚠️ 必须设置为 true，使用离线模式
```

**重要规则**:
- ⚠️ **必须配置 `VECTOR_MODEL_PATH`** 指向本地模型目录
- ⚠️ **必须设置 `VECTOR_OFFLINE_MODE=true`** 确保使用本地模型
- ⚠️ 如果未配置本地路径，模型加载可能失败
- ⚠️ 不要依赖在线下载模型（可能失败或很慢）

### 后端启动

**启动脚本**: `backend/run.py` (唯一正确的启动方式，支持热重载)

**配置文件**: `backend/.env` (必须存在)

**启动命令**:
```bash
cd backend
source venv/bin/activate  # 激活虚拟环境
python run.py             # 使用 run.py 启动（支持热重载）
```

**热重载配置**:
```env
# 开发环境（默认启用热重载）
API_RELOAD=true

# 生产环境（禁用热重载）
API_RELOAD=false
```

**重要规则**:
- ⚠️ **必须使用 `run.py` 启动**，支持热重载功能
- ⚠️ 开发环境默认 `API_RELOAD=true`，修改代码会自动重启
- ⚠️ 如果热重载不工作，检查 `.env` 中 `API_RELOAD=true` 是否设置
- ⚠️ 启动前必须确认 `.env` 文件存在且配置正确
- ⚠️ 启动前必须激活虚拟环境
- ⚠️ 端口默认 8000，如果被占用需要先释放

### 前端启动

**配置文件**: `frontend/.env.local`

**启动命令**:
```bash
cd frontend
pnpm run dev  # 或 npm run dev
```

**重要规则**:
- ⚠️ 前端默认端口 3000（在 `vite.config.ts` 中配置）
- ⚠️ 前端依赖后端服务，确保后端已启动
- ⚠️ 首次运行需要安装依赖：`pnpm install`

### 统一启动脚本

**启动脚本**: `technical-solution/start.sh`

**使用方式**:
```bash
cd technical-solution
./start.sh
```

**脚本功能**:
1. 检查项目结构
2. 检查后端环境配置（.env 文件）
3. 检查数据库连接
4. 检查并激活 Python 虚拟环境
5. 检查前端依赖
6. 启动后端和前端服务

**重要规则**:
- ⚠️ **推荐使用统一启动脚本**，避免配置错误
- ⚠️ 如果脚本检查失败，必须修复问题后再启动

## 📁 项目结构

```
technical-solution/
├── backend/              # 后端服务
│   ├── app/             # FastAPI 应用
│   ├── .env             # ⚠️ 后端环境配置（必须存在）
│   ├── run.py           # ⚠️ 后端启动脚本（唯一正确方式）
│   └── venv/            # Python 虚拟环境
├── frontend/            # 前端应用
│   ├── .env.local       # 前端环境配置
│   └── src/            # 前端源代码
├── start.sh             # ⚠️ 统一启动脚本（推荐使用）
└── SETUP.md             # 配置文档
```

## 🔧 开发规则

### 修改配置时

1. **数据库配置**: 
   - 修改 `backend/.env` 中的数据库配置
   - ⚠️ 永远不要修改 `DB_NAME=ad_case_db`
   - 修改后需要重启后端服务

2. **向量模型配置**:
   - 修改 `backend/.env` 中的 `VECTOR_MODEL_PATH`
   - ⚠️ 必须指向本地模型目录
   - ⚠️ 必须设置 `VECTOR_OFFLINE_MODE=true`
   - 修改后需要重启后端服务

3. **前端配置**:
   - 修改 `frontend/.env.local`
   - 修改后需要重启前端服务

### 启动服务时

1. **使用统一启动脚本**（推荐）:
   ```bash
   cd technical-solution
   ./start.sh
   ```

2. **手动启动**（如果脚本不可用）:
   - 先启动后端（确保虚拟环境已激活）
   - 再启动前端

### 调试时

1. **检查数据库连接**:
   ```bash
   psql -h localhost -p 5432 -U bing -d ad_case_db -c "SELECT 1;"
   ```

2. **检查虚拟环境**:
   ```bash
   which python  # 应该指向 venv/bin/python
   ```

3. **检查向量模型**:
   ```bash
   ls -la /path/to/bge-large-zh-v1.5  # 确认模型文件存在
   ```

4. **检查端口占用**:
   ```bash
   lsof -i :8000  # 后端端口
   lsof -i :3000  # 前端端口
   ```

## 🚫 禁止操作

1. ❌ **不要修改数据库名称** `ad_case_db`
2. ❌ **不要在系统 Python 环境中安装依赖**
3. ❌ **不要直接使用 `uvicorn` 命令启动后端**（使用 `run.py`）
4. ❌ **不要配置在线向量模型**（必须使用本地模型）
5. ❌ **不要在没有激活虚拟环境的情况下启动后端**
6. ❌ **不要连接到错误的数据库**（确认 `DB_NAME=ad_case_db`）

## 📝 配置检查清单

在启动项目或修改配置前，必须确认：

- [ ] 数据库名称是 `ad_case_db`（不要修改）
- [ ] `backend/.env` 文件存在且配置正确
- [ ] Python 虚拟环境已创建并激活
- [ ] `VECTOR_MODEL_PATH` 已配置且指向本地模型目录
- [ ] `VECTOR_OFFLINE_MODE=true` 已设置
- [ ] 使用 `run.py` 启动后端（不是 `uvicorn`）
- [ ] 端口 8000 和 3000 未被占用

## 📚 相关文档

- 详细配置文档: `SETUP.md`
- 后端文档: `backend/README.md`
- 前端文档: `frontend/README.md`
- 数据库文档: `backend/database/README.md`

## 💡 提示

- 遇到问题时，首先检查 `SETUP.md` 中的常见问题部分
- 使用统一启动脚本可以自动检查大部分配置问题
- 修改配置后记得重启相应的服务
