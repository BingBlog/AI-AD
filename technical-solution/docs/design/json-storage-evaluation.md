# JSON 文件存储必要性评估

## 1. 当前 JSON 文件的作用

### 1.1 存储内容

当前系统使用 JSON 文件存储以下内容：

1. **批次文件** (`cases_batch_*.json`)

   - 存储完整的案例数据（title, description, images, tags 等）
   - 每个文件包含一个批次的案例（默认 100 个）
   - 格式：
     ```json
     {
       "batch_num": 0,
       "batch_size": 100,
       "created_at": "2024-01-01T00:00:00",
       "cases": [
         {
           "case_id": 12345,
           "title": "案例标题",
           "description": "案例描述",
           "images": [...],
           ...
         }
       ]
     }
     ```

2. **断点续传文件** (`crawl_resume.json`)
   - 记录已爬取的 case_id 集合
   - 用于断点续传，避免重复爬取
   - 格式：
     ```json
     {
       "total_count": 1000,
       "crawled_ids": [12345, 12346, ...],
       "last_updated": "2024-01-01T00:00:00"
     }
     ```

### 1.2 使用场景

1. **数据导入流程**

   - JSON 文件 → 读取数据 → 生成向量 → 批量入库到 `ad_cases` 表
   - 这是当前架构的核心流程：**先爬取保存 JSON，再入库**

2. **断点续传**

   - 通过 `crawl_resume.json` 记录已爬取的 case_id
   - 通过 `cases_batch_*.json` 验证已保存的案例

3. **数据备份和调试**

   - JSON 文件作为数据备份
   - 可以查看和验证数据质量
   - 方便调试和问题排查

4. **进度统计**
   - 从 JSON 文件计算已保存的案例数
   - 验证已爬取和已保存的一致性

---

## 2. 新增表的功能

### 2.1 crawl_list_pages 表

**存储内容**：

- 列表页爬取状态（success/failed/skipped）
- 错误信息（error_message, error_type）
- 案例数量（items_count）
- 耗时（duration_seconds）
- 重试信息（retry_count, last_retry_at）

**不存储**：

- ❌ 列表页的完整响应数据
- ❌ 案例的完整内容

### 2.2 crawl_case_records 表

**存储内容**：

- 案例爬取状态（success/failed/validation_failed）
- 错误信息（error_message, error_type, error_stack）
- 验证错误详情（validation_errors）
- 保存状态（saved_to_json, batch_file_name）
- 数据质量标记（has_detail_data, has_validation_error）
- 重试信息（retry_count, last_retry_at）

**不存储**：

- ❌ 案例的完整数据（title, description, images 等）
- ❌ 案例的业务字段内容

---

## 3. JSON 文件是否还需要？

### 3.1 评估维度

#### 维度 1：数据完整性

| 项目         | JSON 文件                 | 新增表      | 结论              |
| ------------ | ------------------------- | ----------- | ----------------- |
| 完整案例数据 | ✅ 存储                   | ❌ 不存储   | **JSON 仍需保留** |
| 爬取状态     | ❌ 不存储                 | ✅ 存储     | 新表补充          |
| 错误信息     | ⚠️ 部分存储（error 字段） | ✅ 完整存储 | 新表更完善        |

**结论**：JSON 文件存储完整的案例数据，新表只存储元数据，两者互补。

#### 维度 2：数据导入流程

**当前流程**：

```
爬取 → 保存JSON → 读取JSON → 生成向量 → 入库到ad_cases表
```

**如果去掉 JSON，需要改为**：

```
爬取 → 直接入库到ad_cases表（同时记录到crawl_case_records）
```

**对比分析**：

| 方案                      | 优点                                                                                                                                                                         | 缺点                                                                                                                                     |
| ------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------- |
| **保留 JSON（当前）**     | ✅ 容错性强：爬取失败不影响已保存数据<br>✅ 易于重试：可以单独重跑入库流程<br>✅ 调试方便：可以查看 JSON 文件<br>✅ 可并行处理：爬取和入库分离<br>✅ 数据备份：JSON 作为备份 | ❌ 存储空间大<br>❌ 实时性差<br>❌ 流程复杂                                                                                              |
| **去掉 JSON（直接入库）** | ✅ 实时性好<br>✅ 存储空间小<br>✅ 流程简单                                                                                                                                  | ❌ 容错性差：爬取失败可能导致数据丢失<br>❌ 难以重试：失败后需要重新爬取<br>❌ 调试困难：无法查看中间数据<br>❌ 耦合度高：爬取和入库耦合 |

**结论**：从数据导入流程看，**JSON 文件仍然需要**，因为：

1. 当前架构是"先爬取保存 JSON，再入库"的两阶段流程
2. 去掉 JSON 需要改为直接入库，会失去容错性和灵活性

#### 维度 3：断点续传

**当前方式**：

- `crawl_resume.json` 记录已爬取的 case_id
- `cases_batch_*.json` 验证已保存的案例

**新表方式**：

- `crawl_case_records` 记录每个案例的爬取状态
- `crawl_list_pages` 记录每个列表页的爬取状态

**对比**：

| 功能           | JSON 方式            | 新表方式              | 结论         |
| -------------- | -------------------- | --------------------- | ------------ |
| 记录已爬取案例 | ✅ crawl_resume.json | ✅ crawl_case_records | 新表可以替代 |
| 验证已保存案例 | ✅ 读取 JSON 文件    | ✅ saved_to_json 字段 | 新表可以替代 |
| 记录爬取状态   | ❌ 不支持            | ✅ status 字段        | 新表更完善   |
| 记录错误信息   | ⚠️ 部分支持          | ✅ 完整支持           | 新表更完善   |

**结论**：新表可以替代 JSON 的断点续传功能，但需要改造代码。

#### 维度 4：数据备份和调试

**JSON 文件优势**：

- ✅ 人类可读，方便查看和调试
- ✅ 可以作为数据备份
- ✅ 可以手动修改和验证数据

**新表优势**：

- ✅ 结构化查询，方便统计分析
- ✅ 数据库事务保证一致性
- ✅ 支持复杂查询和关联

**结论**：两者各有优势，JSON 文件在调试和备份方面仍有价值。

---

## 4. 综合评估结论

### 4.1 建议：**保留 JSON 文件，但优化使用方式**

#### 理由：

1. **数据完整性**

   - JSON 文件存储完整的案例数据（title, description, images 等）
   - 新表只存储元数据（状态、错误信息等）
   - 两者互补，不是替代关系

2. **架构设计**

   - 当前架构是"先爬取保存 JSON，再入库"的两阶段流程
   - 这个设计有其优势（容错性、灵活性、可调试性）
   - 改为直接入库会失去这些优势

3. **职责分离**
   - JSON 文件：存储完整的案例数据，作为数据导入的中间格式
   - 新表：记录爬取状态和元数据，用于监控和重试
   - 两者职责不同，可以共存

### 4.2 优化建议

#### 建议 1：简化 JSON 文件的使用

**当前问题**：

- JSON 文件既用于存储数据，又用于断点续传
- 需要读取 JSON 文件来计算进度和统计

**优化方案**：

- 断点续传：主要使用新表（`crawl_case_records`）
- 进度统计：主要从数据库聚合计算
- JSON 文件：仅用于数据导入流程

#### 建议 2：可选的数据导入方式

提供两种导入方式：

1. **从 JSON 导入（当前方式）**

   - 适合：批量导入、数据验证、调试
   - 流程：JSON 文件 → 生成向量 → 入库

2. **直接入库（新增方式）**
   - 适合：实时性要求高、数据量小
   - 流程：爬取 → 生成向量 → 直接入库（同时记录到新表）

#### 建议 3：JSON 文件的生命周期管理

- **保留策略**：导入成功后，可以归档或删除 JSON 文件
- **备份策略**：重要数据可以长期保留 JSON 文件作为备份
- **清理策略**：定期清理已导入的 JSON 文件，释放存储空间

---

## 5. 实施建议

### 5.1 短期（保持现状）

- ✅ 保留 JSON 文件存储
- ✅ 新增两个表用于记录爬取状态
- ✅ JSON 文件和新表各司其职，互补使用

### 5.2 中期（优化使用）

- 🔄 断点续传：主要使用新表，JSON 作为辅助
- 🔄 进度统计：主要从数据库聚合，JSON 作为验证
- 🔄 数据导入：保持 JSON 导入方式，但优化流程

### 5.3 长期（可选优化）

- 🔮 提供直接入库选项（可选）
- 🔮 实现 JSON 文件自动归档和清理
- 🔮 考虑使用对象存储（S3/OSS）替代本地 JSON 文件

---

## 6. 总结

### 6.1 核心结论

**JSON 文件仍然需要保留**，原因：

1. ✅ **数据完整性**：JSON 存储完整的案例数据，新表只存储元数据
2. ✅ **架构设计**：当前两阶段流程（爬取 →JSON→ 入库）有其优势
3. ✅ **职责分离**：JSON 负责数据存储，新表负责状态追踪
4. ✅ **容错性和灵活性**：JSON 文件提供数据备份和调试能力

### 6.2 优化方向

- **简化使用**：减少对 JSON 文件的依赖，主要使用新表进行状态追踪
- **职责明确**：JSON 文件专注于数据存储和导入，新表专注于状态监控和重试
- **生命周期管理**：实现 JSON 文件的归档和清理机制

### 6.3 最终架构

```
┌─────────────────────────────────────────────────────────┐
│ 爬取阶段                                                  │
│  ├─ 爬取列表页 → crawl_list_pages (记录状态)              │
│  ├─ 爬取案例 → crawl_case_records (记录状态)              │
│  └─ 保存数据 → cases_batch_*.json (存储完整数据)          │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│ 导入阶段                                                  │
│  ├─ 读取JSON文件                                          │
│  ├─ 生成向量                                              │
│  └─ 批量入库到 ad_cases 表                                │
└─────────────────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────────────────┐
│ 监控和重试                                                │
│  ├─ 查询 crawl_list_pages (失败的列表页)                  │
│  ├─ 查询 crawl_case_records (失败的案例)                  │
│  └─ 精确重试失败的列表页或案例                            │
└─────────────────────────────────────────────────────────┘
```

**关键点**：

- JSON 文件：数据存储和导入的中间格式
- 新表：状态追踪和精确重试的工具
- 两者互补，共同支撑完整的爬取和导入流程
